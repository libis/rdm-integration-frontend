## Frontend Alignment Prompt

Goal: align the DDI-CDI frontend workflow with the download component while hardening SHACL editing and dataset upload.

Reference assets: posted images of the download component (baseline) and current DDI-CDI component (target state).

### Summary (Oct 25, 2025)
- Environment: backend lives in `/home/eryk/projects/rdm-integration` (Dataverse + integration Go service); frontend is this repo (`rdm-integration-frontend`).
- Typical commands: backend `make dev_up` (brings up docker stack) / `make dev_down`; frontend `npm run test -- --watch=false`, `make fmt`, `make lint`, `ng serve` (via repo script if needed).
- Current state: DDI-CDI Angular tests now pass after spec fixes providing valid Turtle fixtures; SHACL warnings remain due to placeholder Turtle in mocks.
- Data sources: latest cached CDI output stored at `tests/response.json`, sourced from `/api/common/cachedddicdioutput` (ready flag true, warnings about invalid linked DDI XML).
- Upload issue: calling Dataverse add-file API with payload containing only Turtle prefixes triggers 500 with Go JSON decode error (`AddReplaceFileResponse.message` expects string, backend returns object when upload fails). Need to ensure we send full Turtle and handle response schema; integration service logs show only successful generate jobs (no record of the failing upload).
- Outstanding UI work: SHACL form error handling and potential library evaluation (see TODO below).
- SHACL tooling view: ULB Darmstadt’s generic SHACL form component renders fields directly from a SHACL shape graph; it’s viable once we ship full CDI-aligned shapes but currently stalls because we lack a stable root node shape. Without those shapes the renderer can’t reflect our UX or validation needs, so custom Angular forms may serve better until shapes are in place.
- SHACL shape graph research: official DDI Lifecycle SHACL exports live in the `ddimodel` GitHub releases, but no ready-made CDI-specific shapes turned up—available CDI assets are RDF encodings in the `ddi-cdi` repo/spec, so we’d need to derive shapes ourselves or adapt lifecycle ones.

### Concepts refresher
- **Turtle (TTL)** is the compact syntax we use to serialize RDF triples; our generator emits CDI dataset descriptions in this format.
- **RDF vocabularies** like CDI define the predicates/classes (e.g., `cdi:Variable`, `dcterms:title`) that give the TTL meaning.
- **SHACL** is the constraint language layered on RDF; shapes describe what properties/structures should exist and power validation or auto-generated forms. A SHACL form renderer needs both the shape graph (rules) and the data graph (our CDI TTL) to work.

### TODO
- [x] Move the dataset selection dropdown out of the sticky menu and mirror the download component (label, layout, styles).
- [x] Relocate the `Generate DDI-CDI` button into the right sticky menu and reuse the download component iconography.
- [x] Replace the "Select" header text in the tree table with a toggleable checkmark matching the download component behaviour (supports select/deselect all).
- [ ] Investigate and resolve `Error: shacl root node shape not found`, using the captured `response.json` from `/api/common/cachedddicdioutput` to build tests/mocks.
- [x] Ensure `Add to Dataset` always uploads clean Turtle output even when the SHACL editor fails to render.
- [ ] Confirm the SHACL form renders without errors for valid CDI output (address remaining SHACL form issues).
- [ ] Evaluate whether the ULB Darmstadt SHACL form library meets our editor needs; if recommending alternatives, document reasoning and get approval before replacing.
- [ ] Diagnose the HTTP 500 when calling `api/datasets/:persistentId/add` (`json: cannot unmarshal object into ... AddReplaceFileResponse.message`); verify the request payload (`content` currently only prefixes) and align with backend expectations.
- [ ] Host the SHACL shapes we design on the backend alongside the embedded frontend config (`Dockerfile`, `frontend.go` `go:embed all:dist/datasync`).
- [ ] Document SHACL shape hosting/contribution guidance in `ddi-cdi.md`, mirroring how `csv_to_cdi.py` participation is covered.
- [ ] Restrict `xconvert` usage to cases where `GetDataFileDDI` returns no output during the `cdi_ddi.go` job execution path.
- [ ] Extend `image/test_csv_to_cdi.py` to parse and assert against the `testdata/tmp_ddi8.xml` output generated by `GetDataFileDDI`.

### Progress
- Angular unit suite now green after updating `src/app/ddi-cdi/ddi-cdi.component.spec.ts` with valid Turtle fixtures and richer DOM mocks; rerun via `npm run test -- --watch=false`.
- Latest backend fixture in `tests/response.json` cleaned up; use it to drive SHACL mocks and error reproduction.
- Upload attempt now fails server-side with 500 due to response message type mismatch; request body shows only prefix declarations, suggesting serialization stops before data rows.
- DDI-CDI layout now mirrors the download component (dropdown placement, sticky action button, select-all icon); validated via `make test`.

### Next Steps
- Replace remaining placeholder Turtle strings in SHACL pathways to eliminate N3 parser warnings (`ttl-content`, `final-ttl`, `cached-ttl`, etc.).
- Wire the SHACL form integration to emit full CDI Turtle (not just prefixes) before invoking upload.
- Reproduce and trace the add-file 500 in integration logs; confirm expected response schema and adjust request handling or backend client accordingly.
- Continue UI alignment tasks in TODO list once backend flow is stable.
### Notes
- Keep the prompt reusable: add new discoveries or regressions to the checklist above.
- When work completes on any item, flip the checkbox and reference supporting commits/tests.
- Plan carefully and execute step-by-step.
