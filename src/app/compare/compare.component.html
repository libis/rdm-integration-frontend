<!-- Author: Eryk Kulikowski @ KU Leuven (2023). Apache 2.0 License -->
<div class="row justify-content-between sticky-menu">
  <span class="col-auto">
  <button pButton type="button" class="p-button-sm p-button-raised p-button-secondary" (click)="back()"><i class="pi pi-angle-double-left"></i>&nbsp;Return</button>
  </span>

  <span class="col-auto">
    <span class="p-buttonset bulk-actions">
      <span class="bulk-label">Select file actions</span>
  <button pButton type="button" class="p-button-sm p-button-raised" (click)="mirrorSelection()" title="Copy all new and changed files to Dataverse and delete in Dataverse the files that do not exist in the repository" [attr.disabled]="disabled ? '' : null">
        <i [class]="icon_mirror"></i>&nbsp;Mirror
      </button>
  <button pButton type="button" class="p-button-sm p-button-raised" (click)="updateSelection()" title="Copy all new and changed files to Dataverse" [attr.disabled]="disabled ? '' : null">
        <i [class]="icon_update"></i>&nbsp;Copy
      </button>
  <button pButton type="button" class="p-button-sm p-button-raised" (click)="noActionSelection()" title="Do not copy or delete files in Dataverse" [attr.disabled]="disabled ? '' : null">
        <i [class]="icon_noaction"></i>&nbsp;Clear selection
      </button>
    </span>
  </span>

  <span class="col-auto">
  <button pButton type="button" class="p-button-sm p-button-raised" (click)="refresh()" title="Refresh files status" [hidden]="refreshHidden">
      <i class="pi pi-refresh"></i>&nbsp;Refresh
    </button>
  <button style="float: right;" pButton type="button" class="p-button-sm p-button-raised" [ngClass]="hasSelection() ? 'p-button-primary' : 'p-button-secondary'" (click)="submit()" title="Initiate selected changes" [attr.disabled]="disabled ? '' : null">Confirm file selection&nbsp;<i class="pi pi-angle-double-right"></i></button>
  </span>
</div>

<br/>

@if ((rejectedSize && rejectedSize.length) || (rejectedName && rejectedName.length)) {
  <div class="mb-3">
    @if (rejectedSize && rejectedSize.length) {
      <div>
        <table class="table">
          <tbody>
            <tr class="file-list-header">
              <th><i [class]="icon_warning" style="color:red"></i> Files exceeding maximum allowed size ({{ maxFileSize }} bytes):</th>
            </tr>
            <tr>
              <table class="table">
                <tbody>
                  @for (fileName of rejectedSize; track fileName) {
                    <tr><td><span>{{ fileName }}</span></td></tr>
                  }
                </tbody>
              </table>
            </tr>
          </tbody>
        </table>
      </div>
    }
    @if (rejectedName && rejectedName.length) {
      <div>
        <table class="table">
          <tbody>
            <tr class="file-list-header">
              <th><i [class]="icon_warning" style="color:red"></i> Files with unsupported characters (allowed patterns shown below):</th>
            </tr>
            <tr>
              <table class="table">
                <tbody>
                  @for (fileName of rejectedName; track fileName) {
                    <tr><td><span>{{ fileName }}</span></td></tr>
                  }
                </tbody>
              </table>
            </tr>
            <tr>
              <td class="small text-muted px-3 pb-2">
                Allowed file name pattern: <code>{{ allowedFileNamePattern }}</code><br/>
                Allowed folder path pattern: <code>{{ allowedFolderPathPattern }}</code>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    }
  </div>
}

<div height="100% - 2em; overflow: hidden;">
  <p-treeTable [value]="rootNodeChildren" [loading]="loading">
    <ng-template pTemplate="header">
      <tr>
  <th>{{ repo() }} <span [hidden]="!repoName()">({{ repoName() }})</span></th>
        <th class="icon_col" style="text-align: center;">
          <span title="Comparison status">
            <p-popover #op appendTo="body">
              <p-table [value]="filterItems" [(selection)]="selectedFilterItems" dataKey="label">
                <ng-template pTemplate="header">
                  <tr>
                    <th title="Show all files">
                      <p-tableHeaderCheckbox (click)="updateFilters()"></p-tableHeaderCheckbox>
                    </th>
                    <th>Comparison status</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr [title]="product.title">
                    <td>
                      <p-tableCheckbox [value]="product" (click)="updateFilters()"></p-tableCheckbox>
                    </td>
                    <td><i [style]="product.iconStyle" [class]="product.icon"></i>&nbsp;{{ product.label }}</td>
                  </tr>
                </ng-template>
              </p-table>
              <button pButton type="button" class="p-button-link" (click)="showAll()" title="Show all">Show all...</button>
            </p-popover>
            <button pButton type="button" class="p-button-sm p-button-raised" icon="pi pi-filter" (click)="op.toggle($event)" [attr.disabled]="disabled ? '' : null"></button>
          </span>
        </th>
        <th class="icon_col" style="text-align: center;">
          <span title="Action">
            <i [class]="icon_action"></i>
          </span>
        </th>
        <th style="text-align:right;">
          {{ isNewDataset() ? dataverseHeaderNoColon() : dataverseHeader() }}
          (
          @if (!isNewDataset()) {
            <a [href]="data!.url" target="_blank">{{ data!.id }}</a>
          } @else {
            {{ displayDatasetId() }}
          }
          )
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
      <tr app-datafile [hidden]="rowData.hidden" [datafile]="rowData" [loading]="loading" [rowNodeMap]="rowNodeMap" [rowNode]="rowNode" [isInFilter]="isInFilterMode" [style]="rowClass(rowData)">
      </ng-template>
    </p-treeTable>
  </div>
