<!-- Author: Eryk Kulikowski @ KU Leuven (2024). Apache 2.0 License -->
<div class="row justify-content-between align-items-center sticky-menu">
  <div class="col-auto">
    @if (generatedDdiCdi) {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        (click)="submitGenerate()"
      >
        Regenerate
      </button>
    }
  </div>
  @if (showDVToken()) {
    <div class="col-auto">
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text">Token:&nbsp;</span>
        </div>
        <input
          type="password"
          class="form-control"
          id="dataverseToken"
          placeholder="Dataverse API token"
          [(ngModel)]="dataverseToken"
          #ctrl="ngModel"
          (onChange)="onUserChange()"
        />
      </div>
    </div>
  }
  <div class="col text-center">
    <h2 class="page-title m-0">Generate DDI-CDI Metadata</h2>
  </div>
  <div class="col-auto d-flex" style="gap: 0.5rem">
    @if (showAddFileButton()) {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        [disabled]="loading"
        (click)="openAddFileDialog()"
      >
        Add to Dataset
      </button>
    } @else {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        [disabled]="generateDisabled()"
        (click)="submitGenerate()"
      >
        Generate DDI-CDI
      </button>
    }
  </div>
</div>

<br />

<div class="mb-3">
  <label for="datasetId" class="form-label">Dataset DOI</label>
  <p-select
    appendTo="body"
    autoWidth="false"
    [style]="{ width: '100%' }"
    [editable]="datasetFieldEditable()"
    id="datasetId"
    [options]="doiItems"
    [filter]="true"
    filterBy="label"
    [resetFilterOnHide]="true"
    (onFilter)="onDatasetSearch($event.filter)"
    [(ngModel)]="datasetId"
    (onClick)="getDoiOptions()"
    (onChange)="onDatasetChange()"
  ></p-select>
</div>

<!-- Info box about file filtering -->
@if (datasetId) {
  <div class="alert alert-info" role="alert">
    <i class="pi pi-info-circle"></i>&nbsp; <strong>DDI-CDI Generation</strong
    ><br />
    Only compatible files are shown below (csv, tsv, tab, sps, sas, dct). All
    compatible files are automatically selected. You can change the selection in
    the table below.
  </div>
}

<!-- Submit Generation Dialog -->
<p-dialog
  header="Generate DDI-CDI Metadata"
  position="topright"
  [modal]="true"
  [(visible)]="submitPopup"
>
  <p class="m-0">
    Click on "OK" to start the DDI-CDI generation. The job will run
    asynchronously.
  </p>
  <p class="m-0" [hidden]="!sendMails()">
    You will receive an email notification if the generation fails.
  </p>
  <p class="m-0">
    <strong>You can close the browser window</strong> and the generation will
    continue in the background.
  </p>
  <br /><br />
  <div style="text-align: right">
    <div class="field-checkbox" [hidden]="!sendMails()">
      <p-checkbox
        [(ngModel)]="sendEmailOnSuccess"
        [binary]="true"
        inputId="sendEmailOnSuccessCB"
      ></p-checkbox>
      <label for="sendEmailOnSuccessCB"
        >Email me when the generation is completed</label
      >
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      (onClick)="submitPopup = false"
      styleClass="p-button-sm p-button-raised p-button-secondary"
      >Cancel</p-button
    >
    <p-button
      (onClick)="continueSubmitGenerate()"
      styleClass="p-button-sm p-button-raised p-button-primary"
      >OK</p-button
    >
  </ng-template>
</p-dialog>

<!-- Add File to Dataset Dialog -->
<p-dialog
  header="Add DDI-CDI File to Dataset"
  position="topright"
  [modal]="true"
  [(visible)]="addFilePopup"
>
  <p class="m-0">
    This will add the generated DDI-CDI Turtle file to your dataset.
  </p>
  <p class="m-0">
    The file will be named: <strong>ddi-cdi-[timestamp].ttl</strong>
  </p>
  <br />
  <p class="m-0">Do you want to continue?</p>
  <ng-template pTemplate="footer">
    <p-button
      (onClick)="addFilePopup = false"
      styleClass="p-button-sm p-button-raised p-button-secondary"
      >Cancel</p-button
    >
    <p-button
      (onClick)="addFileToDataset()"
      styleClass="p-button-sm p-button-raised p-button-primary"
      >Add File</p-button
    >
  </ng-template>
</p-dialog>

<div style="height: 100% - 2rem; overflow: hidden">
  <div style="float: left; width: 50%">
    <p-tabs [(value)]="activeTab">
      <p-tablist>
        <p-tab value="files">Select files</p-tab>
        <p-tab value="console">Console output</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="files">
          <p-treeTable
            [value]="rootNodeChildren"
            [loading]="loading"
            loadingIcon=" pi pi-spin pi-spinner"
          >
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: left">
                  <a [href]="data!.url" target="_blank">{{ data!.id }}</a>
                </th>
                <th class="icon_col" style="text-align: right; width: 100px">
                  <button
                    pButton
                    type="button"
                    class="p-button-sm p-button-outlined p-button-secondary"
                    title="Toggle select all"
                    (click)="toggleSelectAll()"
                  >
                    <i [class]="selectAllIcon()"></i>
                  </button>
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
              <tr [ttRow]="rowNode" [style]="getFileStyle(rowData.name || '')">
                <td>
                  {{ rowData.name }}
                </td>
                <td style="text-align: center">
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="isFileSelected(rowData.name || '')"
                    (ngModelChange)="toggleFileSelection(rowData.name || '')"
                  ></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-treeTable>
        </p-tabpanel>
        <p-tabpanel value="console">
          <div style="margin-bottom: 0.5rem">
            <strong>Console Output:</strong>
          </div>
          <textarea
            autosize
            [minRows]="20"
            [maxRows]="25"
            [(ngModel)]="output"
            readonly
            [disabled]="outputDisabled"
            class="console-output"
            style="width: 100%; font-family: monospace; font-size: 0.9rem"
          ></textarea>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
  <div style="float: right; width: 50%">
    @if (generatedDdiCdi) {
      <div style="text-align: right; margin-bottom: 0.5rem">
        <p-button
          [disabled]="loading"
          (onClick)="refreshOutput()"
          styleClass="p-button-raised p-button-secondary header-button"
          title="Reload the form (this discards unsaved edits)"
        >
          Reload form
        </p-button>
      </div>
      <!-- SHACL Form for editing DDI-CDI -->
      <div
        [style.width]="'100%'"
        [style.margin]="'0.2rem'"
        [style.height]="'600px'"
        [style.overflow]="'auto'"
        [style.padding]="'1rem'"
        [style.border]="'1px solid var(--p-surface-border)'"
        [style.border-radius]="'var(--p-border-radius)'"
        [style.background-color]="'var(--p-content-background)'"
      >
        @if (shaclError) {
          <div class="shacl-error" [style.white-space]="'pre-line'">
            {{ shaclError }}
          </div>
          <textarea
            autosize
            [minRows]="15"
            [maxRows]="15"
            [value]="generatedDdiCdi"
            readonly
            style="font-family: monospace; margin-top: 1rem"
          ></textarea>
        } @else {
          <shacl-form
            #shaclForm
            [attr.data-shapes]="shaclShapes"
            [attr.data-shape-subject]="shaclShapeSubject ?? null"
            [attr.data-values]="generatedDdiCdi"
            [attr.data-values-format]="'text/turtle'"
            [attr.data-shapes-format]="'text/turtle'"
            [attr.data-values-subject]="shaclTargetNode ?? null"
            data-dense="true"
            style="display: block; width: 100%"
          ></shacl-form>
        }
      </div>
    }
  </div>
</div>
