<!-- Author: Eryk Kulikowski @ KU Leuven (2024). Apache 2.0 License -->
<div class="row justify-content-between align-items-center sticky-menu">
  <div class="col-auto">
    @if (generatedDdiCdi) {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        (click)="submitGenerate()"
      >
        <i class="pi pi-angle-double-left"></i>&nbsp;Regenerate
      </button>
    }
  </div>
  @if (showDVToken()) {
    <div class="col-auto">
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text">Token:&nbsp;</span>
        </div>
        <input
          type="password"
          class="form-control"
          id="dataverseToken"
          placeholder="Dataverse API token"
          [(ngModel)]="dataverseToken"
          #ctrl="ngModel"
          (onChange)="onUserChange()"
        />
      </div>
    </div>
  }
  <div class="col text-center">
    <h2 class="page-title m-0">Generate DDI-CDI Metadata</h2>
  </div>
  <div class="col-auto d-flex" style="gap: 0.5rem">
    @if (generatedDdiCdi) {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-secondary header-button"
        [disabled]="loading"
        (click)="downloadDdiCdi()"
        title="Download the generated DDI-CDI JSON-LD file"
      >
        <i class="pi pi-download"></i>&nbsp;Download
      </button>
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        [disabled]="loading"
        (click)="openInViewer()"
        title="Saves the DDI-CDI file to your dataset and opens it in the CDI Viewer for editing"
      >
        Save &amp; Edit&nbsp;<i class="pi pi-external-link"></i>
      </button>
    } @else {
      <button
        pButton
        type="button"
        class="p-button-sm p-button-raised p-button-primary header-button"
        [disabled]="generateDisabled()"
        (click)="submitGenerate()"
      >
        Generate DDI-CDI&nbsp;<i class="pi pi-angle-double-right"></i>
      </button>
    }
  </div>
</div>

<br />

<div class="mb-3">
  <label for="datasetId" class="form-label">Dataset DOI</label>
  <p-select
    appendTo="body"
    autoWidth="false"
    [style]="{ width: '100%' }"
    [editable]="datasetFieldEditable()"
    id="datasetId"
    [options]="doiItems"
    [filter]="true"
    filterBy="label"
    [resetFilterOnHide]="true"
    (onFilter)="onDatasetSearch($event.filter)"
    [(ngModel)]="datasetId"
    (onClick)="getDoiOptions()"
    (onChange)="onDatasetChange()"
  ></p-select>
</div>

<!-- Info box about file filtering -->
@if (datasetId) {
  <div class="alert alert-info" role="alert">
    <i class="pi pi-info-circle"></i>&nbsp; <strong>DDI-CDI Generation</strong
    ><br />
    Only compatible files are shown below (csv, tsv, tab, sps, sas, dct). All
    compatible files are automatically selected. You can change the selection in
    the table below.
  </div>
}

<!-- Submit Generation Dialog -->
<p-dialog
  header="Generate DDI-CDI Metadata"
  position="topright"
  [modal]="true"
  [(visible)]="submitPopup"
>
  <p class="m-0">
    Click on "OK" to start the DDI-CDI generation. The job will run
    asynchronously.
  </p>
  <p class="m-0" [hidden]="!sendMails()">
    You will receive an email notification if the generation fails.
  </p>
  <p class="m-0">
    <strong>You can close the browser window</strong> and the generation will
    continue in the background.
  </p>
  <br /><br />
  <div style="text-align: right">
    <div class="field-checkbox" [hidden]="!sendMails()">
      <p-checkbox
        [(ngModel)]="sendEmailOnSuccess"
        [binary]="true"
        inputId="sendEmailOnSuccessCB"
      ></p-checkbox>
      <label for="sendEmailOnSuccessCB"
        >Email me when the generation is completed</label
      >
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      (onClick)="submitPopup = false"
      styleClass="p-button-sm p-button-raised p-button-secondary"
      >Cancel</p-button
    >
    <p-button
      (onClick)="continueSubmitGenerate()"
      styleClass="p-button-sm p-button-raised p-button-primary"
      >OK</p-button
    >
  </ng-template>
</p-dialog>

<div style="height: 100% - 2rem; overflow: hidden">
  <div style="float: left; width: 50%">
    <p-tabs [(value)]="activeTab">
      <p-tablist>
        <p-tab value="files">Select files</p-tab>
        <p-tab value="console">Console output</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="files">
          <p-treeTable
            [value]="rootNodeChildren"
            [loading]="loading"
            loadingIcon=" pi pi-spin pi-spinner"
          >
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: left">
                  <a [href]="data!.url" target="_blank">{{ data!.id }}</a>
                </th>
                <th class="icon_col" style="text-align: right; width: 100px">
                  <button
                    pButton
                    type="button"
                    class="p-button-sm p-button-outlined p-button-secondary"
                    title="Toggle select all"
                    (click)="toggleSelectAll()"
                  >
                    <i [class]="selectAllIcon()"></i>
                  </button>
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
              <tr [ttRow]="rowNode" [style]="getFileStyle(rowData.name || '')">
                <td>
                  {{ rowData.name }}
                </td>
                <td style="text-align: center">
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="isFileSelected(rowData.name || '')"
                    (ngModelChange)="toggleFileSelection(rowData.name || '')"
                  ></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-treeTable>
        </p-tabpanel>
        <p-tabpanel value="console">
          <textarea
            autosize
            [minRows]="20"
            [maxRows]="25"
            [(ngModel)]="output"
            readonly
            [disabled]="outputDisabled"
            class="console-output"
            style="width: 100%; font-family: monospace; font-size: 0.9rem"
          ></textarea>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
  <div style="float: right; width: 50%">
    @if (generatedDdiCdi) {
      <div style="text-align: left; margin-bottom: 0.5rem">
        <strong>Generated DDI-CDI Output</strong>
        <span style="color: var(--p-text-muted-color); margin-left: 1rem">
          Use "Download" to save locally, or "Save &amp; Edit" to add to your
          dataset and open in the CDI Viewer.
        </span>
      </div>
      <!-- DDI-CDI JSON-LD Preview -->
      <div
        [style.width]="'100%'"
        [style.margin]="'0.2rem'"
        [style.height]="'600px'"
        [style.overflow]="'auto'"
        [style.border]="'1px solid var(--p-surface-border)'"
        [style.border-radius]="'var(--p-border-radius)'"
        [style.background-color]="'var(--p-content-background)'"
      >
        <pre
          style="
            font-family: monospace;
            font-size: 0.85rem;
            padding: 1rem;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
          "
          >{{ generatedDdiCdi }}</pre
        >
      </div>
    }
  </div>
</div>
